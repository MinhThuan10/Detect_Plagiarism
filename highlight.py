from pymongo import MongoClient
import fitz  # PyMuPDF
import random
import io
from bson import Binary

client = MongoClient('mongodb://localhost:27017/')
db = client['Plagiarism_PDF']
collection_sentences = db['sentences']
collection_files = db['files']

color_hex = ['#0c0c0c', '#0de349', '#0fc686', '#11aac3', '#138e0c', '#157249', '#175586', '#1939c3', '#1b1d0c', 
             '#1bf449', '#1dd886', '#1fbbc3', '#21a00c', '#238349', '#256786', '#274ac3', '#292e0c', '#2b1249', 
             '#2ce986', '#2eccc3', '#2fb10c', '#319449', '#337886', '#355bc3', '#37400c', '#392349', '#3afa86', 
             '#3cddc3', '#3ec20c', '#40a549', '#418986', '#436cc3', '#45510c', '#473449', '#491886', '#4aeec3', 
             '#4cd30c', '#4eb649', '#509a86', '#527dc3', '#54620c', '#554549', '#572986', '#590cc3', '#5ae40c', 
             '#5cc749', '#5eab86', '#608ec3', '#62730c', '#645649', '#663a86', '#671dc3', '#68f50c', '#6ad949', 
             '#6cbc86', '#6ea0c3', '#70840c', '#726749', '#744b86', '#762ec3', '#78130c', '#79ea49', '#7acd86', 
             '#7cb1c3', '#7e950c', '#807949', '#825c86', '#8440c3', '#86240c', '#87fb49', '#89de86', '#8bc2c3', 
             '#8da60c', '#8e8a49', '#906d86', '#9251c3', '#94350c', '#961949', '#97ef86', '#99d3c3', '#9bb70c', 
             '#9d9b49', '#9f7e86', '#a062c3', '#a2460c', '#a42a49', '#a60d86', '#a7e4c3', '#a9c80c', '#abac49', 
             '#ad8f86', '#af73c3', '#b1570c', '#b33b49', '#b41e86', '#b5f5c3', '#b7d90c', '#b9bd49', '#bba086', 
             '#bd84c3', '#bf680c', '#c14c49', '#c32f86', '#c513c3', '#c5eb0c', '#c7ce49', '#c9b286', '#cb95c3', 
             '#cd7a0c', '#cf5d49', '#d14186', '#d324c3', '#d4fc0c', '#d6df49', '#d8c386', '#d9a6c3', '#db8b0c', 
             '#dd6e49', '#df5286', '#e135c3', '#e31a0c', '#e4f049', '#e6d486', '#e8b7c3', '#ea9c0c', '#eb7f49', 
             '#ed6386', '#ef46c3', '#f12b0c', '#f30e49', '#f4e586', '#f6c8c3', '#f8ad0c', '#fa9049', '#fc7486', 
             '#fe57c3', '#0c3c0d', '#0e1f4a', '#0ff687', '#11d9c4', '#13be0d', '#15a14a', '#178587', '#1968c4', 
             '#1b4d0d', '#1c304a', '#1e1487', '#1febc4', '#21cf0d', '#23b34a', '#259687', '#277ac4', '#295e0d', 
             '#2b414a', '#2d2587', '#2efcc4', '#2fe00d', '#31c44a', '#33a787', '#358bc4', '#376f0d', '#39534a', 
             '#3b3687', '#3d1ac4', '#3ef10d', '#40d54a', '#41b887', '#439cc4', '#45800d', '#47644a', '#494787', 
             '#4b2bc4', '#4d0f0d', '#4ee64a', '#50c987', '#52adc4', '#54910d', '#55754a', '#575887', '#593cc4', 
             '#5b200d', '#5cf74a', '#5eda87', '#60bec4', '#62a20d', '#64864a', '#666987', '#674dc4', '#69310d', 
             '#6b154a', '#6ceb87', '#6ecfc4', '#70b30d', '#72974a', '#747a87', '#765ec4', '#78420d', '#7a264a',
             '#7afd87', '#7ce0c4', '#7ec50d', '#80a84a', '#828c87', '#846fc4', '#86540d', '#88374a', '#8a1b87', 
             '#8bf1c4', '#8dd60d', '#8eb94a', '#909d87', '#9280c4', '#94650d', '#96484a', '#982c87', '#9a0fc4', 
             '#9be70d', '#9dca4a', '#9fae87', '#a091c4', '#a2760d', '#a4594a', '#a63d87', '#a820c4', '#a9f80d', 
             '#abdb4a', '#adbf87', '#afa2c4', '#b1870d', '#b36a4a', '#b44e87', '#b631c4', '#b8160d', '#b9ec4a', 
             '#bbd087', '#bdb3c4', '#bf980d', '#c17b4a', '#c35f87', '#c542c4', '#c6270d', '#c7fe4a', '#c9e187', 
             '#cbc5c4', '#cda90d', '#cf8d4a', '#d17087', '#d354c4', '#d5380d', '#d71b4a', '#d8f287', '#d9d6c4', 
             '#dbba0d', '#dd9e4a', '#df8187', '#e165c4', '#e3490d', '#e52d4a', '#e71087', '#e8e7c4', '#eacb0d',
             '#ebaf4a', '#ed9287', '#ef76c4', '#f15a0d', '#f33e4a', '#f52187', '#f6f8c4', '#f8dc0d', '#fac04a', 
             '#fca387', '#fe87c4', '#0c6b0e', '#0e4f4b', '#103288', '#1216c5', '#13ed0e', '#15d14b', '#17b488', 
             '#1998c5', '#1b7c0e', '#1c604b', '#1e4388', '#2027c5', '#21ff0e', '#23e24b', '#25c588', '#27a9c5', 
             '#298d0e', '#2b714b', '#2d5488', '#2e38c5', '#301c0e', '#31f34b', '#33d788', '#35bac5', '#379f0e', 
             '#39824b', '#3b6688', '#3d49c5', '#3f2e0e', '#41114b', '#41e888', '#43cbc5', '#45b00e', '#47934b', 
             '#497788', '#4b5ac5', '#4d3f0e', '#4f224b', '#50f988', '#52dcc5', '#54c10e', '#55a44b', '#578888', 
             '#596bc5', '#5b500e', '#5d334b', '#5f1788', '#60edc5', '#62d20e', '#64b54b', '#669988', '#677cc5', 
             '#69610e', '#6b444b', '#6d2888', '#6effc5', '#70e30e', '#72c64b', '#74aa88', '#768dc5', '#78720e', 
             '#7a554b', '#7b3988', '#7d1cc5', '#7ef40e', '#80d84b', '#82bb88', '#849fc5', '#86830e', '#88674b', 
             '#8a4a88', '#8c2ec5', '#8d120e', '#8ee94b', '#90cc88', '#92b0c5', '#94940e', '#96784b', '#985b88', 
             '#9a3fc5', '#9c230e', '#9dfa4b', '#9fdd88', '#a0c1c5', '#a2a50e', '#a4894b', '#a66c88', '#a850c5', 
             '#aa340e', '#ac184b', '#adee88', '#afd2c5', '#b1b60e', '#b39a4b', '#b47d88', '#b661c5', '#b8450e', 
             '#ba294b', '#bc0c88', '#bde3c5', '#bfc70e', '#c1ab4b', '#c38e88', '#c572c5', '#c6560e', '#c83a4b', 
             '#ca1d88', '#cbf4c5', '#cdd90e', '#cfbc4b', '#d1a088', '#d383c5', '#d5670e', '#d74b4b', '#d92e88', 
             '#da12c5', '#dbea0e', '#ddcd4b', '#dfb188', '#e194c5', '#e3790e', '#e55c4b', '#e74088', '#e923c5', 
             '#eafb0e', '#ebde4b', '#edc288', '#efa5c5', '#f18a0e', '#f36d4b', '#f55188', '#f734c5', '#f9190e', 
             '#faef4b', '#fcd388', '#feb6c5', '#0c9b0f', '#0e7e4c', '#106289', '#1245c5', '#142a0f', '#160d4c', 
             '#17e489', '#19c7c5', '#1bac0f', '#1c8f4c', '#1e7389', '#2056c5', '#223b0f', '#241e4c', '#25f589',
             '#27d9c5', '#29bd0f', '#2ba04c', '#2d8489', '#2e67c5', '#304c0f', '#322f4c', '#341389', '#35eac5', 
             '#37ce0f', '#39b24c', '#3b9589', '#3d79c5', '#3f5d0f', '#41414c', '#422489', '#43fbc5', '#45df0f', 
             '#47c34c', '#49a689', '#4b8ac5', '#4d6e0f', '#4f524c', '#513589', '#5319c5', '#54f00f', '#55d44c', 
             '#57b789', '#599bc5', '#5b7f0f', '#5d634c', '#5f4689', '#612ac5', '#630e0f', '#64e54c', '#66c889', 
             '#67acc5', '#69900f', '#6b744c', '#6d5789', '#6f3bc5', '#711f0f', '#72f64c', '#74d989', '#76bdc5', 
             '#78a10f', '#7a854c', '#7b6889', '#7d4cc5', '#7f300f', '#81144c', '#82eb89', '#84cec5', '#86b30f', 
             '#88964c', '#8a7a89', '#8c5dc5', '#8d410f', '#8f254c', '#90fc89', '#92dfc5', '#94c40f', '#96a74c', 
             '#988b89', '#9a6ec5', '#9c530f', '#9e364c', '#a01a89', '#a0f0c5', '#a2d50f', '#a4b84c', '#a69c89', 
             '#a87fc5', '#aa640f', '#ac474c', '#ae2b89', '#b00ec5']


color_rbg = [(0.05, 0.05, 0.05), (0.05372549019607843, 0.8919607843137255, 0.2884313725490196), (0.0611764705882353, 0.7801960784313726, 0.5268627450980392),
(0.06862745098039216, 0.6684313725490196, 0.7652941176470588), (0.07607843137254902, 0.5603921568627451, 0.05), (0.08352941176470588, 0.44862745098039214, 0.2884313725490196),
(0.09098039215686275, 0.3368627450980392, 0.5268627450980392),(0.09843137254901961, 0.22509803921568627, 0.7652941176470588),(0.10588235294117647, 0.11705882352941177, 0.05),
(0.10960784313725491, 0.9590196078431373, 0.2884313725490196), (0.11705882352941177, 0.8472549019607843, 0.5268627450980392),
(0.12450980392156863, 0.7354901960784314, 0.7652941176470588),(0.1319607843137255, 0.6274509803921569, 0.05),
(0.13941176470588235, 0.5156862745098039, 0.2884313725490196),
(0.1468627450980392, 0.403921568627451, 0.5268627450980392),
(0.15431372549019606, 0.292156862745098, 0.7652941176470588),
(0.16176470588235295, 0.18411764705882352, 0.05),
(0.1692156862745098, 0.07235294117647059, 0.2884313725490196),
(0.17294117647058826, 0.9143137254901961, 0.5268627450980392),
(0.18039215686274512, 0.8025490196078431, 0.7652941176470588),
(0.18784313725490198, 0.6945098039215687, 0.05),
(0.19529411764705884, 0.5827450980392157, 0.2884313725490196),
(0.2027450980392157, 0.4709803921568627, 0.5268627450980392),
(0.21019607843137256, 0.35921568627450984, 0.7652941176470588),
(0.21764705882352942, 0.2511764705882353, 0.05),
(0.22509803921568627, 0.13941176470588235, 0.2884313725490196),
(0.2288235294117647, 0.9813725490196078, 0.5268627450980392),
(0.23627450980392156, 0.8696078431372549, 0.7652941176470588),
(0.24372549019607842, 0.7615686274509804, 0.05),
(0.2511764705882353, 0.6498039215686274, 0.2884313725490196),
(0.25862745098039214, 0.5380392156862744, 0.5268627450980392),
(0.26607843137254905, 0.42627450980392156, 0.7652941176470588),
(0.2735294117647059, 0.31823529411764706, 0.05),
(0.28098039215686277, 0.20647058823529413, 0.2884313725490196),
(0.2884313725490196, 0.09470588235294117, 0.5268627450980392),
(0.292156862745098, 0.9366666666666666, 0.7652941176470588),
(0.2996078431372549, 0.8286274509803921, 0.05),
(0.3070588235294118, 0.7168627450980392, 0.2884313725490196),
(0.31450980392156863, 0.6050980392156863, 0.5268627450980392),
(0.3219607843137255, 0.49333333333333335, 0.7652941176470588),
(0.32941176470588235, 0.38529411764705884, 0.05),
(0.3368627450980392, 0.2735294117647059, 0.2884313725490196),
(0.34431372549019607, 0.16176470588235295, 0.5268627450980392),
(0.3517647058823529, 0.05, 0.7652941176470588),
(0.3554901960784314, 0.8956862745098039, 0.05),
(0.3629411764705882, 0.783921568627451, 0.2884313725490196),
(0.3703921568627451, 0.672156862745098, 0.5268627450980392),
(0.37784313725490193, 0.5603921568627451, 0.7652941176470588),
(0.38529411764705884, 0.45235294117647057, 0.05),
(0.3927450980392157, 0.3405882352941177, 0.2884313725490196),
(0.40019607843137256, 0.2288235294117647, 0.5268627450980392),
(0.4076470588235294, 0.11705882352941177, 0.7652941176470588),
(0.41137254901960785, 0.9627450980392157, 0.05),
(0.4188235294117647, 0.8509803921568627, 0.2884313725490196),
(0.42627450980392156, 0.7392156862745097, 0.5268627450980392),
(0.4337254901960784, 0.6274509803921569, 0.7652941176470588),
(0.4411764705882353, 0.5194117647058824, 0.05),
(0.44862745098039214, 0.4076470588235294, 0.2884313725490196),
(0.456078431372549, 0.2958823529411765, 0.5268627450980392),
(0.4635294117647059, 0.18411764705882352, 0.7652941176470588),
(0.4709803921568627, 0.07607843137254902, 0.05),
(0.4747058823529412, 0.9180392156862744, 0.2884313725490196),
(0.48215686274509806, 0.8062745098039216, 0.5268627450980392),
(0.4896078431372549, 0.6945098039215687, 0.7652941176470588),
(0.4970588235294118, 0.5864705882352941, 0.05),
(0.5045098039215686, 0.4747058823529412, 0.2884313725490196),
(0.5119607843137255, 0.3629411764705882, 0.5268627450980392),
(0.5194117647058824, 0.2511764705882353, 0.7652941176470588),
(0.5268627450980392, 0.14313725490196078, 0.05),
(0.5305882352941176, 0.9850980392156862, 0.2884313725490196),
(0.5380392156862744, 0.8733333333333334, 0.5268627450980392),
(0.5454901960784314, 0.7615686274509804, 0.7652941176470588),
(0.5529411764705883, 0.6535294117647058, 0.05),
(0.5603921568627451, 0.541764705882353, 0.2884313725490196),
(0.5678431372549019, 0.43000000000000005, 0.5268627450980392),
(0.5752941176470588, 0.31823529411764706, 0.7652941176470588),
(0.5827450980392157, 0.21019607843137256, 0.05),
(0.5901960784313726, 0.09843137254901961, 0.2884313725490196),
(0.5939215686274509, 0.9403921568627451, 0.5268627450980392),
(0.6013725490196079, 0.8286274509803921, 0.7652941176470588),
(0.6088235294117648, 0.7205882352941176, 0.05),
(0.6162745098039215, 0.6088235294117648, 0.2884313725490196),
(0.6237254901960784, 0.4970588235294118, 0.5268627450980392),
(0.6311764705882353, 0.38529411764705884, 0.7652941176470588),
(0.6386274509803922, 0.27725490196078434, 0.05),
(0.6460784313725491, 0.16549019607843138, 0.2884313725490196),
(0.6535294117647058, 0.05372549019607843, 0.5268627450980392),
(0.6572549019607843, 0.8956862745098039, 0.7652941176470588),
(0.6647058823529413, 0.7876470588235295, 0.05),
(0.672156862745098, 0.6758823529411765, 0.2884313725490196),
(0.6796078431372549, 0.5641176470588235, 0.5268627450980392),
(0.6870588235294117, 0.45235294117647057, 0.7652941176470588),
(0.6945098039215687, 0.34431372549019607, 0.05),
(0.7019607843137254, 0.23254901960784316, 0.2884313725490196),
(0.7094117647058823, 0.1207843137254902, 0.5268627450980392),
(0.7131372549019608, 0.9627450980392157, 0.7652941176470588),
(0.7205882352941176, 0.8547058823529412, 0.05),
(0.7280392156862745, 0.7429411764705882, 0.2884313725490196),
(0.7354901960784314, 0.6311764705882353, 0.5268627450980392),
(0.7429411764705882, 0.5194117647058824, 0.7652941176470588),
(0.7503921568627452, 0.41137254901960785, 0.05),
(0.7578431372549019, 0.2996078431372549, 0.2884313725490196),
(0.7652941176470588, 0.18784313725490198, 0.5268627450980392),
(0.7727450980392156, 0.07607843137254902, 0.7652941176470588),
(0.776470588235294, 0.9217647058823529, 0.05),
(0.783921568627451, 0.81, 0.2884313725490196),
(0.7913725490196079, 0.6982352941176471, 0.5268627450980392),
(0.7988235294117647, 0.5864705882352941, 0.7652941176470588),
(0.8062745098039216, 0.47843137254901963, 0.05),
(0.8137254901960784, 0.36666666666666664, 0.2884313725490196),
(0.8211764705882353, 0.2549019607843137, 0.5268627450980392),
(0.8286274509803921, 0.14313725490196078, 0.7652941176470588),
(0.8323529411764705, 0.9888235294117648, 0.05),
(0.8398039215686275, 0.8770588235294118, 0.2884313725490196),
(0.8472549019607843, 0.7652941176470588, 0.5268627450980392),
(0.8547058823529412, 0.6535294117647058, 0.7652941176470588),
(0.862156862745098, 0.5454901960784314, 0.05),
(0.8696078431372549, 0.4337254901960784, 0.2884313725490196),
(0.8770588235294118, 0.3219607843137255, 0.5268627450980392),
(0.8845098039215686, 0.21019607843137256, 0.7652941176470588),
(0.8919607843137255, 0.10215686274509804, 0.05),
(0.8956862745098039, 0.9441176470588235, 0.2884313725490196),
(0.9031372549019608, 0.8323529411764705, 0.5268627450980392),
(0.9105882352941177, 0.7205882352941176, 0.7652941176470588),
(0.9180392156862744, 0.6125490196078431, 0.05),
(0.9254901960784313, 0.5007843137254901, 0.2884313725490196),
(0.9329411764705883, 0.38901960784313727, 0.5268627450980392),
(0.9403921568627451, 0.27725490196078434, 0.7652941176470588),
(0.9478431372549019, 0.1692156862745098, 0.05),
(0.9552941176470587, 0.05745098039215687, 0.2884313725490196),
(0.9590196078431373, 0.8994117647058824, 0.5268627450980392),
(0.9664705882352941, 0.7876470588235295, 0.7652941176470588),
(0.9739215686274509, 0.6796078431372549, 0.05),
(0.9813725490196078, 0.5678431372549019, 0.2884313725490196),
(0.9888235294117648, 0.456078431372549, 0.5268627450980392),
(0.9962745098039216, 0.34431372549019607, 0.7652941176470588),
(0.05, 0.23627450980392156, 0.05372549019607843),
(0.05745098039215687, 0.12450980392156863, 0.292156862745098),
(0.0611764705882353, 0.9664705882352941, 0.5305882352941176),
(0.06862745098039216, 0.8547058823529412, 0.7690196078431373),
(0.07607843137254902, 0.7466666666666666, 0.05372549019607843),
(0.08352941176470588, 0.6349019607843137, 0.292156862745098),
(0.09098039215686275, 0.5231372549019608, 0.5305882352941176),
(0.09843137254901961, 0.41137254901960785, 0.7690196078431373),
(0.10588235294117647, 0.30333333333333334, 0.05372549019607843),
(0.11333333333333334, 0.19156862745098038, 0.292156862745098),
(0.1207843137254902, 0.07980392156862745, 0.5305882352941176),
(0.12450980392156863, 0.9217647058823529, 0.7690196078431373),
(0.1319607843137255, 0.8137254901960784, 0.05372549019607843),
(0.13941176470588235, 0.7019607843137254, 0.292156862745098),
(0.1468627450980392, 0.5901960784313726, 0.5305882352941176),
(0.15431372549019606, 0.47843137254901963, 0.7690196078431373),
(0.16176470588235295, 0.3703921568627451, 0.05372549019607843),
(0.1692156862745098, 0.25862745098039214, 0.292156862745098),
(0.17666666666666667, 0.1468627450980392, 0.5305882352941176),
(0.18039215686274512, 0.9888235294117648, 0.7690196078431373),
(0.18784313725490198, 0.8807843137254902, 0.05372549019607843),
(0.19529411764705884, 0.7690196078431373, 0.292156862745098),
(0.2027450980392157, 0.6572549019607843, 0.5305882352941176),
(0.21019607843137256, 0.5454901960784314, 0.7690196078431373),
(0.21764705882352942, 0.43745098039215685, 0.05372549019607843),
(0.22509803921568627, 0.3256862745098039, 0.292156862745098),
(0.23254901960784316, 0.213921568627451, 0.5305882352941176),
(0.24000000000000002, 0.10215686274509804, 0.7690196078431373),
(0.24372549019607842, 0.9478431372549019, 0.05372549019607843),
(0.2511764705882353, 0.836078431372549, 0.292156862745098),
(0.25862745098039214, 0.7243137254901961, 0.5305882352941176),
(0.26607843137254905, 0.6125490196078431, 0.7690196078431373),
(0.2735294117647059, 0.5045098039215686, 0.05372549019607843),
(0.28098039215686277, 0.3927450980392157, 0.292156862745098),
(0.2884313725490196, 0.28098039215686277, 0.5305882352941176),
(0.2958823529411765, 0.1692156862745098, 0.7690196078431373),
(0.30333333333333334, 0.0611764705882353, 0.05372549019607843),
(0.3070588235294118, 0.9031372549019608, 0.292156862745098),
(0.31450980392156863, 0.7913725490196079, 0.5305882352941176),
(0.3219607843137255, 0.6796078431372549, 0.7690196078431373),
(0.32941176470588235, 0.5715686274509805, 0.05372549019607843),
(0.3368627450980392, 0.4598039215686275, 0.292156862745098),
(0.34431372549019607, 0.3480392156862745, 0.5305882352941176),
(0.3517647058823529, 0.23627450980392156, 0.7690196078431373),
(0.35921568627450984, 0.12823529411764706, 0.05372549019607843),
(0.3629411764705882, 0.9701960784313726, 0.292156862745098),
(0.3703921568627451, 0.8584313725490196, 0.5305882352941176),
(0.37784313725490193, 0.7466666666666666, 0.7690196078431373),
(0.38529411764705884, 0.6386274509803922, 0.05372549019607843),
(0.3927450980392157, 0.5268627450980392, 0.292156862745098),
(0.40019607843137256, 0.4150980392156863, 0.5305882352941176),
(0.4076470588235294, 0.30333333333333334, 0.7690196078431373),
(0.4150980392156863, 0.19529411764705884, 0.05372549019607843),
(0.42254901960784313, 0.08352941176470588, 0.292156862745098),
(0.42627450980392156, 0.9254901960784313, 0.5305882352941176),
(0.4337254901960784, 0.8137254901960784, 0.7690196078431373),
(0.4411764705882353, 0.7056862745098039, 0.05372549019607843),
(0.44862745098039214, 0.5939215686274509, 0.292156862745098),
(0.456078431372549, 0.48215686274509806, 0.5305882352941176),
(0.4635294117647059, 0.3703921568627451, 0.7690196078431373),
(0.4709803921568627, 0.2623529411764706, 0.05372549019607843),
(0.47843137254901963, 0.15058823529411763, 0.292156862745098),
(0.48215686274509806, 0.9925490196078431, 0.5305882352941176),
(0.4896078431372549, 0.8807843137254902, 0.7690196078431373),
(0.4970588235294118, 0.7727450980392156, 0.05372549019607843),
(0.5045098039215686, 0.6609803921568628, 0.292156862745098),
(0.5119607843137255, 0.5492156862745098, 0.5305882352941176),
(0.5194117647058824, 0.43745098039215685, 0.7690196078431373),
(0.5268627450980392, 0.32941176470588235, 0.05372549019607843),
(0.5343137254901961, 0.21764705882352942, 0.292156862745098),
(0.541764705882353, 0.10588235294117647, 0.5305882352941176),
(0.5454901960784314, 0.9478431372549019, 0.7690196078431373),
(0.5529411764705883, 0.8398039215686275, 0.05372549019607843),
(0.5603921568627451, 0.7280392156862745, 0.292156862745098),
(0.5678431372549019, 0.6162745098039215, 0.5305882352941176),
(0.5752941176470588, 0.5045098039215686, 0.7690196078431373),
(0.5827450980392157, 0.3964705882352941, 0.05372549019607843),
(0.5901960784313726, 0.2847058823529412, 0.292156862745098),
(0.5976470588235294, 0.17294117647058826, 0.5305882352941176),
(0.6050980392156863, 0.0611764705882353, 0.7690196078431373),
(0.6088235294117648, 0.9068627450980392, 0.05372549019607843),
(0.6162745098039215, 0.7950980392156862, 0.292156862745098),
(0.6237254901960784, 0.6833333333333333, 0.5305882352941176),
(0.6311764705882353, 0.5715686274509805, 0.7690196078431373),
(0.6386274509803922, 0.4635294117647059, 0.05372549019607843),
(0.6460784313725491, 0.3517647058823529, 0.292156862745098),
(0.6535294117647058, 0.24000000000000002, 0.5305882352941176),
(0.6609803921568628, 0.12823529411764706, 0.7690196078431373),
(0.6647058823529413, 0.9739215686274509, 0.05372549019607843),
(0.672156862745098, 0.862156862745098, 0.292156862745098),
(0.6796078431372549, 0.7503921568627452, 0.5305882352941176),
(0.6870588235294117, 0.6386274509803922, 0.7690196078431373),
(0.6945098039215687, 0.5305882352941176, 0.05372549019607843),
(0.7019607843137254, 0.4188235294117647, 0.292156862745098),
(0.7094117647058823, 0.3070588235294118, 0.5305882352941176),
(0.7168627450980392, 0.19529411764705884, 0.7690196078431373),
(0.7243137254901961, 0.08725490196078431, 0.05372549019607843),
(0.7280392156862745, 0.9292156862745098, 0.292156862745098),
(0.7354901960784314, 0.8174509803921569, 0.5305882352941176),
(0.7429411764705882, 0.7056862745098039, 0.7690196078431373),
(0.7503921568627452, 0.5976470588235294, 0.05372549019607843),
(0.7578431372549019, 0.48588235294117643, 0.292156862745098),
(0.7652941176470588, 0.37411764705882355, 0.5305882352941176),
(0.7727450980392156, 0.2623529411764706, 0.7690196078431373),
(0.7801960784313726, 0.15431372549019606, 0.05372549019607843),
(0.783921568627451, 0.9962745098039216, 0.292156862745098),
(0.7913725490196079, 0.8845098039215686, 0.5305882352941176),
(0.7988235294117647, 0.7727450980392156, 0.7690196078431373),
(0.8062745098039216, 0.6647058823529413, 0.05372549019607843),
(0.8137254901960784, 0.5529411764705883, 0.292156862745098),
(0.8211764705882353, 0.4411764705882353, 0.5305882352941176),
(0.8286274509803921, 0.32941176470588235, 0.7690196078431373),
(0.836078431372549, 0.22137254901960784, 0.05372549019607843),
(0.8435294117647059, 0.10960784313725491, 0.292156862745098),
(0.8472549019607843, 0.9515686274509804, 0.5305882352941176),
(0.8547058823529412, 0.8398039215686275, 0.7690196078431373),
(0.862156862745098, 0.731764705882353, 0.05372549019607843),
(0.8696078431372549, 0.62, 0.292156862745098),
(0.8770588235294118, 0.5082352941176471, 0.5305882352941176),
(0.8845098039215686, 0.3964705882352941, 0.7690196078431373),
(0.8919607843137255, 0.2884313725490196, 0.05372549019607843),
(0.8994117647058824, 0.17666666666666667, 0.292156862745098),
(0.9068627450980392, 0.06490196078431373, 0.5305882352941176),
(0.9105882352941177, 0.9068627450980392, 0.7690196078431373),
(0.9180392156862744, 0.7988235294117647, 0.05372549019607843),
(0.9254901960784313, 0.6870588235294117, 0.292156862745098),
(0.9329411764705883, 0.5752941176470588, 0.5305882352941176),
(0.9403921568627451, 0.4635294117647059, 0.7690196078431373),
(0.9478431372549019, 0.3554901960784314, 0.05372549019607843),
(0.9552941176470587, 0.24372549019607842, 0.292156862745098),
(0.9627450980392157, 0.1319607843137255, 0.5305882352941176),
(0.9664705882352941, 0.9739215686274509, 0.7690196078431373),
(0.9739215686274509, 0.8658823529411764, 0.05372549019607843),
(0.9813725490196078, 0.7541176470588236, 0.292156862745098),
(0.9888235294117648, 0.6423529411764706, 0.5305882352941176),
(0.9962745098039216, 0.5305882352941176, 0.7690196078431373),
(0.05, 0.42254901960784313, 0.05745098039215687),
(0.05745098039215687, 0.3107843137254902, 0.2958823529411765),
(0.06490196078431373, 0.19901960784313727, 0.5343137254901961),
(0.07235294117647059, 0.08725490196078431, 0.7727450980392156),
(0.07607843137254902, 0.9329411764705883, 0.05745098039215687),
(0.08352941176470588, 0.8211764705882353, 0.2958823529411765),
(0.09098039215686275, 0.7094117647058823, 0.5343137254901961),
(0.09843137254901961, 0.5976470588235294, 0.7727450980392156),
(0.10588235294117647, 0.4896078431372549, 0.05745098039215687),
(0.11333333333333334, 0.37784313725490193, 0.2958823529411765),
(0.1207843137254902, 0.26607843137254905, 0.5343137254901961),
(0.12823529411764706, 0.15431372549019606, 0.7727450980392156),
(0.1319607843137255, 1.0, 0.05745098039215687),
(0.13941176470588235, 0.888235294117647, 0.2958823529411765),
(0.1468627450980392, 0.776470588235294, 0.5343137254901961),
(0.15431372549019606, 0.6647058823529413, 0.7727450980392156),
(0.16176470588235295, 0.5566666666666666, 0.05745098039215687),
(0.1692156862745098, 0.44490196078431377, 0.2958823529411765),
(0.17666666666666667, 0.3331372549019608, 0.5343137254901961),
(0.18411764705882352, 0.22137254901960784, 0.7727450980392156),
(0.19156862745098038, 0.11333333333333334, 0.05745098039215687),
(0.19529411764705884, 0.9552941176470587, 0.2958823529411765),
(0.2027450980392157, 0.8435294117647059, 0.5343137254901961),
(0.21019607843137256, 0.731764705882353, 0.7727450980392156),
(0.21764705882352942, 0.6237254901960784, 0.05745098039215687),
(0.22509803921568627, 0.5119607843137255, 0.2958823529411765),
(0.23254901960784316, 0.40019607843137256, 0.5343137254901961),
(0.24000000000000002, 0.2884313725490196, 0.7727450980392156),
(0.24745098039215688, 0.18039215686274512, 0.05745098039215687),
(0.2549019607843137, 0.06862745098039216, 0.2958823529411765),
(0.25862745098039214, 0.9105882352941177, 0.5343137254901961),
(0.26607843137254905, 0.7988235294117647, 0.7727450980392156),
(0.2735294117647059, 0.6907843137254902, 0.05745098039215687),
(0.28098039215686277, 0.5790196078431373, 0.2958823529411765),
(0.2884313725490196, 0.4672549019607843, 0.5343137254901961),
(0.2958823529411765, 0.3554901960784314, 0.7727450980392156),
(0.30333333333333334, 0.24745098039215688, 0.05745098039215687),
(0.3107843137254902, 0.13568627450980392, 0.2958823529411765),
(0.31450980392156863, 0.9776470588235294, 0.5343137254901961),
(0.3219607843137255, 0.8658823529411764, 0.7727450980392156),
(0.32941176470588235, 0.7578431372549019, 0.05745098039215687),
(0.3368627450980392, 0.6460784313725491, 0.2958823529411765),
(0.34431372549019607, 0.5343137254901961, 0.5343137254901961),
(0.3517647058823529, 0.42254901960784313, 0.7727450980392156),
(0.35921568627450984, 0.31450980392156863, 0.05745098039215687),
(0.36666666666666664, 0.2027450980392157, 0.2958823529411765),
(0.37411764705882355, 0.09098039215686275, 0.5343137254901961),
(0.37784313725490193, 0.9329411764705883, 0.7727450980392156),
(0.38529411764705884, 0.8249019607843138, 0.05745098039215687),
(0.3927450980392157, 0.7131372549019608, 0.2958823529411765),
(0.40019607843137256, 0.6013725490196079, 0.5343137254901961),
(0.4076470588235294, 0.4896078431372549, 0.7727450980392156),
(0.4150980392156863, 0.38156862745098036, 0.05745098039215687),
(0.42254901960784313, 0.2698039215686275, 0.2958823529411765),
(0.43000000000000005, 0.1580392156862745, 0.5343137254901961),
(0.4337254901960784, 1.0, 0.7727450980392156),
(0.4411764705882353, 0.8919607843137255, 0.05745098039215687),
(0.44862745098039214, 0.7801960784313726, 0.2958823529411765),
(0.456078431372549, 0.6684313725490196, 0.5343137254901961),
(0.4635294117647059, 0.5566666666666666, 0.7727450980392156),
(0.4709803921568627, 0.44862745098039214, 0.05745098039215687),
(0.47843137254901963, 0.3368627450980392, 0.2958823529411765),
(0.48588235294117643, 0.22509803921568627, 0.5343137254901961),
(0.49333333333333335, 0.11333333333333334, 0.7727450980392156),
(0.4970588235294118, 0.9590196078431373, 0.05745098039215687),
(0.5045098039215686, 0.8472549019607843, 0.2958823529411765),
(0.5119607843137255, 0.7354901960784314, 0.5343137254901961),
(0.5194117647058824, 0.6237254901960784, 0.7727450980392156),
(0.5268627450980392, 0.5156862745098039, 0.05745098039215687),
(0.5343137254901961, 0.403921568627451, 0.2958823529411765),
(0.541764705882353, 0.292156862745098, 0.5343137254901961),
(0.5492156862745098, 0.18039215686274512, 0.7727450980392156),
(0.5566666666666666, 0.07235294117647059, 0.05745098039215687),
(0.5603921568627451, 0.9143137254901961, 0.2958823529411765),
(0.5678431372549019, 0.8025490196078431, 0.5343137254901961),
(0.5752941176470588, 0.6907843137254902, 0.7727450980392156),
(0.5827450980392157, 0.5827450980392157, 0.05745098039215687),
(0.5901960784313726, 0.4709803921568627, 0.2958823529411765),
(0.5976470588235294, 0.35921568627450984, 0.5343137254901961),
(0.6050980392156863, 0.24745098039215688, 0.7727450980392156),
(0.6125490196078431, 0.13941176470588235, 0.05745098039215687),
(0.6162745098039215, 0.9813725490196078, 0.2958823529411765),
(0.6237254901960784, 0.8696078431372549, 0.5343137254901961),
(0.6311764705882353, 0.7578431372549019, 0.7727450980392156),
(0.6386274509803922, 0.6498039215686274, 0.05745098039215687),
(0.6460784313725491, 0.5380392156862744, 0.2958823529411765),
(0.6535294117647058, 0.42627450980392156, 0.5343137254901961),
(0.6609803921568628, 0.31450980392156863, 0.7727450980392156),
(0.6684313725490196, 0.20647058823529413, 0.05745098039215687),
(0.6758823529411765, 0.09470588235294117, 0.2958823529411765),
(0.6796078431372549, 0.9366666666666666, 0.5343137254901961),
(0.6870588235294117, 0.8249019607843138, 0.7727450980392156),
(0.6945098039215687, 0.7168627450980392, 0.05745098039215687),
(0.7019607843137254, 0.6050980392156863, 0.2958823529411765),
(0.7094117647058823, 0.49333333333333335, 0.5343137254901961),
(0.7168627450980392, 0.38156862745098036, 0.7727450980392156),
(0.7243137254901961, 0.2735294117647059, 0.05745098039215687),
(0.731764705882353, 0.16176470588235295, 0.2958823529411765),
(0.7392156862745097, 0.05, 0.5343137254901961),
(0.7429411764705882, 0.8919607843137255, 0.7727450980392156),
(0.7503921568627452, 0.783921568627451, 0.05745098039215687),
(0.7578431372549019, 0.672156862745098, 0.2958823529411765),
(0.7652941176470588, 0.5603921568627451, 0.5343137254901961),
(0.7727450980392156, 0.44862745098039214, 0.7727450980392156),
(0.7801960784313726, 0.3405882352941177, 0.05745098039215687),
(0.7876470588235295, 0.2288235294117647, 0.2958823529411765),
(0.7950980392156862, 0.11705882352941177, 0.5343137254901961),
(0.7988235294117647, 0.9590196078431373, 0.7727450980392156),
(0.8062745098039216, 0.8509803921568627, 0.05745098039215687),
(0.8137254901960784, 0.7392156862745097, 0.2958823529411765),
(0.8211764705882353, 0.6274509803921569, 0.5343137254901961),
(0.8286274509803921, 0.5156862745098039, 0.7727450980392156),
(0.836078431372549, 0.4076470588235294, 0.05745098039215687),
(0.8435294117647059, 0.2958823529411765, 0.2958823529411765),
(0.8509803921568627, 0.18411764705882352, 0.5343137254901961),
(0.8584313725490196, 0.07235294117647059, 0.7727450980392156),
(0.862156862745098, 0.9180392156862744, 0.05745098039215687),
(0.8696078431372549, 0.8062745098039216, 0.2958823529411765),
(0.8770588235294118, 0.6945098039215687, 0.5343137254901961),
(0.8845098039215686, 0.5827450980392157, 0.7727450980392156),
(0.8919607843137255, 0.4747058823529412, 0.05745098039215687),
(0.8994117647058824, 0.3629411764705882, 0.2958823529411765),
(0.9068627450980392, 0.2511764705882353, 0.5343137254901961),
(0.9143137254901961, 0.13941176470588235, 0.7727450980392156),
(0.9180392156862744, 0.9850980392156862, 0.05745098039215687),
(0.9254901960784313, 0.8733333333333334, 0.2958823529411765),
(0.9329411764705883, 0.7615686274509804, 0.5343137254901961),
(0.9403921568627451, 0.6498039215686274, 0.7727450980392156),
(0.9478431372549019, 0.541764705882353, 0.05745098039215687),
(0.9552941176470587, 0.43000000000000005, 0.2958823529411765),
(0.9627450980392157, 0.31823529411764706, 0.5343137254901961),
(0.9701960784313726, 0.20647058823529413, 0.7727450980392156),
(0.9776470588235294, 0.09843137254901961, 0.05745098039215687),
(0.9813725490196078, 0.9403921568627451, 0.2958823529411765),
(0.9888235294117648, 0.8286274509803921, 0.5343137254901961),
(0.9962745098039216, 0.7168627450980392, 0.7727450980392156),
(0.05, 0.6088235294117648, 0.0611764705882353),
(0.05745098039215687, 0.4970588235294118, 0.2996078431372549),
(0.06490196078431373, 0.38529411764705884, 0.5380392156862744),
(0.07235294117647059, 0.2735294117647059, 0.776470588235294),
(0.07980392156862745, 0.16549019607843138, 0.0611764705882353),
(0.08725490196078431, 0.05372549019607843, 0.2996078431372549),
(0.09098039215686275, 0.8956862745098039, 0.5380392156862744),
(0.09843137254901961, 0.783921568627451, 0.776470588235294),
(0.10588235294117647, 0.6758823529411765, 0.0611764705882353),
(0.11333333333333334, 0.5641176470588235, 0.2996078431372549),
(0.1207843137254902, 0.45235294117647057, 0.5380392156862744),
(0.12823529411764706, 0.3405882352941177, 0.776470588235294),
(0.13568627450980392, 0.23254901960784316, 0.0611764705882353),
(0.14313725490196078, 0.1207843137254902, 0.2996078431372549),
(0.1468627450980392, 0.9627450980392157, 0.5380392156862744),
(0.15431372549019606, 0.8509803921568627, 0.776470588235294),
(0.16176470588235295, 0.7429411764705882, 0.0611764705882353),
(0.1692156862745098, 0.6311764705882353, 0.2996078431372549),
(0.17666666666666667, 0.5194117647058824, 0.5380392156862744),
(0.18411764705882352, 0.4076470588235294, 0.776470588235294),
(0.19156862745098038, 0.2996078431372549, 0.0611764705882353),
(0.19901960784313727, 0.18784313725490198, 0.2996078431372549),
(0.20647058823529413, 0.07607843137254902, 0.5380392156862744),
(0.21019607843137256, 0.9180392156862744, 0.776470588235294),
(0.21764705882352942, 0.81, 0.0611764705882353),
(0.22509803921568627, 0.6982352941176471, 0.2996078431372549),
(0.23254901960784316, 0.5864705882352941, 0.5380392156862744),
(0.24000000000000002, 0.4747058823529412, 0.776470588235294),
(0.24745098039215688, 0.36666666666666664, 0.0611764705882353),
(0.2549019607843137, 0.2549019607843137, 0.2996078431372549),
(0.2623529411764706, 0.14313725490196078, 0.5380392156862744),
(0.26607843137254905, 0.9850980392156862, 0.776470588235294),
(0.2735294117647059, 0.8770588235294118, 0.0611764705882353),
(0.28098039215686277, 0.7652941176470588, 0.2996078431372549),
(0.2884313725490196, 0.6535294117647058, 0.5380392156862744),
(0.2958823529411765, 0.541764705882353, 0.776470588235294),
(0.30333333333333334, 0.4337254901960784, 0.0611764705882353),
(0.3107843137254902, 0.3219607843137255, 0.2996078431372549),
(0.31823529411764706, 0.21019607843137256, 0.5380392156862744),
(0.3256862745098039, 0.09843137254901961, 0.776470588235294),
(0.32941176470588235, 0.9441176470588235, 0.0611764705882353),
(0.3368627450980392, 0.8323529411764705, 0.2996078431372549),
(0.34431372549019607, 0.7205882352941176, 0.5380392156862744),
(0.3517647058823529, 0.6088235294117648, 0.776470588235294),
(0.35921568627450984, 0.5007843137254901, 0.0611764705882353),
(0.36666666666666664, 0.38901960784313727, 0.2996078431372549),
(0.37411764705882355, 0.27725490196078434, 0.5380392156862744),
(0.38156862745098036, 0.16549019607843138, 0.776470588235294),
(0.38901960784313727, 0.05745098039215687, 0.0611764705882353),
(0.3927450980392157, 0.8994117647058824, 0.2996078431372549),
(0.40019607843137256, 0.7876470588235295, 0.5380392156862744),
(0.4076470588235294, 0.6758823529411765, 0.776470588235294),
(0.4150980392156863, 0.5678431372549019, 0.0611764705882353),
(0.42254901960784313, 0.456078431372549, 0.2996078431372549),
(0.43000000000000005, 0.34431372549019607, 0.5380392156862744),
(0.43745098039215685, 0.23254901960784316, 0.776470588235294),
(0.44490196078431377, 0.12450980392156863, 0.0611764705882353),
(0.44862745098039214, 0.9664705882352941, 0.2996078431372549),
(0.456078431372549, 0.8547058823529412, 0.5380392156862744),
(0.4635294117647059, 0.7429411764705882, 0.776470588235294),
(0.4709803921568627, 0.6349019607843137, 0.0611764705882353),
(0.47843137254901963, 0.5231372549019608, 0.2996078431372549),
(0.48588235294117643, 0.41137254901960785, 0.5380392156862744),
(0.49333333333333335, 0.2996078431372549, 0.776470588235294),
(0.5007843137254901, 0.19156862745098038, 0.0611764705882353),
(0.5082352941176471, 0.07980392156862745, 0.2996078431372549),
(0.5119607843137255, 0.9217647058823529, 0.5380392156862744),
(0.5194117647058824, 0.81, 0.776470588235294),
(0.5268627450980392, 0.7019607843137254, 0.0611764705882353),
(0.5343137254901961, 0.5901960784313726, 0.2996078431372549),
(0.541764705882353, 0.47843137254901963, 0.5380392156862744),
(0.5492156862745098, 0.36666666666666664, 0.776470588235294),
(0.5566666666666666, 0.25862745098039214, 0.0611764705882353),
(0.5641176470588235, 0.1468627450980392, 0.2996078431372549),
(0.5678431372549019, 0.9888235294117648, 0.5380392156862744),
(0.5752941176470588, 0.8770588235294118, 0.776470588235294),
(0.5827450980392157, 0.7690196078431373, 0.0611764705882353),
(0.5901960784313726, 0.6572549019607843, 0.2996078431372549),
(0.5976470588235294, 0.5454901960784314, 0.5380392156862744),
(0.6050980392156863, 0.4337254901960784, 0.776470588235294),
(0.6125490196078431, 0.3256862745098039, 0.0611764705882353),
(0.62, 0.213921568627451, 0.2996078431372549),
(0.6274509803921569, 0.10215686274509804, 0.5380392156862744),
(0.6311764705882353, 0.9441176470588235, 0.776470588235294),
(0.6386274509803922, 0.836078431372549, 0.0611764705882353),
(0.6460784313725491, 0.7243137254901961, 0.2996078431372549),
(0.6535294117647058, 0.6125490196078431, 0.5380392156862744),
(0.6609803921568628, 0.5007843137254901, 0.776470588235294),
(0.6684313725490196, 0.3927450980392157, 0.0611764705882353),
(0.6758823529411765, 0.28098039215686277, 0.2996078431372549),
(0.6833333333333333, 0.1692156862745098, 0.5380392156862744),
(0.6907843137254902, 0.05745098039215687, 0.776470588235294)]

school_color_map = {}

def retrieve_pdf_from_mongodb(file_id):
    file_data = collection_files.find_one({"file_id": file_id, "type": 'raw'})
    if file_data:
        return file_data['content']
    return None

def retrieve_pdf_view_all(file_id):
    file_data = collection_files.find_one({"file_id": file_id, "type": 'view_all'})
    if file_data:
        return file_data['content']
    return None
def get_best_sources(file_id):
    all_documents = collection_sentences.find({
        "file_id": file_id,
        "sources": {"$ne": None, "$ne": []}
    })

    best_sources_list = []

    for doc in all_documents:
        sources = doc.get('sources', [])

        if sources:
            best_source = max(sources, key=lambda x: x['score'])

            result = {
                "page": doc.get('page', None),
 # Thông tin 'page' ở cấp ngoài cùng
                "school_id": best_source['school_id'],
                "school_name": best_source['school_name'],
                "file_id": best_source['file_id'],
                "file_name": best_source['file_name'],
                "best_match": best_source['best_match'],
                "score": best_source['score'],
                "highlight": best_source['highlight']
            }

            best_sources_list.append(result)

    return best_sources_list

def get_sources(file_id):
    all_documents = collection_sentences.find({
        "file_id": file_id,
        "sources": {"$ne": None, "$ne": []}
    })

    sources_list = []

    for doc in all_documents:
        sources = doc.get('sources', [])
        for source in sources:
            result = {
                "page": doc.get('page', None),
                "school_id": source['school_id'],
                "school_name": source['school_name'],
                "file_id": source['file_id'],
                "file_name": source['file_name'],
                "best_match": source['best_match'],
                "score": source['score'],
                "highlight": source['highlight']
            }
            sources_list.append(result)

    return sources_list

def add_highlight_to_page(page, x0, y0, x1, y1, color):
    """
    Thêm chú thích nổi bật vào trang PDF tại vùng xác định bởi các tọa độ với màu sắc cụ thể.
    
    Args:
    page (fitz.Page): Đối tượng trang PDF.
    x0 (float): Tọa độ x của góc trên bên trái.
    y0 (float): Tọa độ y của góc trên bên trái.
    x1 (float): Tọa độ x của góc dưới bên phải.
    y1 (float): Tọa độ y của góc dưới bên phải.
    color (tuple): Màu sắc dưới dạng (R, G, B).
    """
    highlight = page.add_highlight_annot(fitz.Rect(x0, y0, x1, y1))
    highlight.set_colors(stroke=color)  
    highlight.update()  

def highlight(file_id):
    best_sources = get_best_sources(file_id)
    pdf_binary = retrieve_pdf_from_mongodb(file_id)

    if pdf_binary is None:
        print("Không tìm thấy file PDF trong MongoDB.")
        return

    # Mở file PDF từ dữ liệu nhị phân
    pdf_stream = fitz.open(stream=pdf_binary, filetype='pdf')

    for source in best_sources:
        page_num = source.get('page', None)
        positions = source['highlight'].get('position', None)
        school_id = source['school_id']
        
        color_index = school_id % len(color_rbg)  
        color = color_rbg[color_index]

        if page_num is not None and positions:
            page = pdf_stream.load_page(page_num)

            for position in positions:
                x_0 = position.get('x_0')
                y_0 = position.get('y_0')
                x_1 = position.get('x_1')
                y_1 = position.get('y_1')
                add_highlight_to_page(page, x_0, y_0, x_1, y_1, color)
    return pdf_stream

def highlight_school(file_id, school_id):
    file_id = int(file_id)
    school_id = int(school_id)
    best_sources = get_sources(file_id)
    pdf_binary = retrieve_pdf_from_mongodb(file_id)
    if pdf_binary is None:
        print("Không tìm thấy file PDF trong MongoDB.")
        return
    # Mở file PDF từ dữ liệu nhị phân
    pdf_stream = fitz.open(stream=pdf_binary, filetype='pdf')

    for source in best_sources:
        if source.get('school_id') == school_id:
            page_num = source.get('page', None)
            positions = source['highlight'].get('position', None)
            
            color_index = school_id % len(color_rbg)  
            color = color_rbg[color_index]

            if page_num is not None and positions:
                page = pdf_stream.load_page(page_num)

                for position in positions:
                    x_0 = position.get('x_0')
                    y_0 = position.get('y_0')
                    x_1 = position.get('x_1')
                    y_1 = position.get('y_1')
                    add_highlight_to_page(page, x_0, y_0, x_1, y_1, color)
    pdf_output_stream = io.BytesIO()

    pdf_stream.save(pdf_output_stream)
    pdf_stream.close()

    result = {
        "content": Binary(pdf_output_stream.getvalue()), 
    }
    filter_condition = {"file_id": 1, "type": 'view_all'} 
    update_operation = {"$set": result}
    collection_files.update_one(filter_condition, update_operation)
    return pdf_stream


def wrap_paragraphs_with_color(paragraphs, best_match, school_id):
    color_index = school_id % len(color_hex)
    color = color_hex[color_index]

    highlighted_text = best_match
    for paragraph in paragraphs:
        highlighted_text = highlighted_text.replace(paragraph, f'<span style="background-color:{color};">{paragraph}</span>')

    return highlighted_text
