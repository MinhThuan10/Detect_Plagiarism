<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plagiarism Checker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .pdf-viewer {
            width: 100%;
            height: 90vh;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: scroll; /* Thêm để cuộn dọc */
        }
        .school-box {
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        .sentence-box {
            padding-left: 20px;
        }
        .statistics-box {
            height: 500px;
            overflow-y: scroll;
            background-color: #f8f9fa;
            padding: 15px;
        }
        .index-school-view{
            position: relative;
            top: -14px;
            left: -14px;
            padding: 1px 8px 2px;
            border-radius: 50px;
        }   

        canvas {
            display: block;
            margin: auto;
        }

        .school_name{
            display: flex;
            justify-content: space-between;
        }

        .source-detail{
            display: flex;
            justify-content: space-between;
        }
        
        .sentence-list{
            list-style: none;
            padding: 0;
        }
        .icon-remove{
            font-size: 20px;
        }
        .controls {
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }

    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <!-- Ô bên trái hiển thị nội dung PDF -->
            <div class="col-md-9"`>
                <h2>PDF Viewer</h2>
                <!-- Hiển thị PDF bằng iframe -->
                <div class="overlapping" style="display: block;">
                    <div class="pdf-viewer" id="pdf-viewer"></div>
                </div>
            </div>
            
            
            <!-- Ô bên phải hiển thị thông tin và báo cáo -->
            <div class="col-md-3">
                <h3>Standard Report</h3>
                <div class="mb-4">
                    <strong>Page Count:</strong> {{ page_count }} <br>
                    <strong>Word Count:</strong> {{ word_count }}
                </div>

                <h4>Sources</h4>

                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="toggle-sources" onclick="toggleOverlappingSources()">
                    <label class="form-check-label" for="toggle-sources">Show overlapping sources</label>
                </div>
                <div class="overlapping" style="display: block;">
                    <strong>Percentage:</strong> {{ percent }} %
                </div>
                <div class="statistics-box overlapping-off" style="display: block;">
                    {% for school_id, school_data in school_source_off %}
                        <div class="school-box school-box-off highlight_school{{ school_id }}" onclick="toggleSchool_Off('{{ school_id }}')">
                            <strong class="index-school-view index-school-view-off" style="background-color: {{ school_data['color'] }};">{{ loop.index }}</strong>

                            <div class="school_name">
                                <h5 style="color: {{school_data['color']}};">{{ school_data['school_name'] }}</h5> 
                                <i class="bi bi-x-circle icon-remove"onclick="removeSchoolSource_Off('{{school_id}}')"></i>
                            </div>
                            <br>
                            <strong>Word Matched:</strong> {{ school_data['word_count'] }}<br>
                            <strong>Percentage:</strong> {{ "%.2f" % ((school_data['word_count'] / word_count) * 100) }}%
                        </div>

                        <div class="sentence-box sentence-box-off" id="overlapping-off-{{ school_id }}" style="display: none;">
                            <ul class="sentence-list" id="sentence-list-off-{{ school_id }}">
                                {% for sentence_index, sentence_data in school_data['sentences'].items() %}
                                    <li class="sentence-item"data-page="{{ sentence_data['page'] }}">
                                        <a href="{{ sentence_data['file_id'] }}">{{ sentence_data['file_id'] }}</a><br>
                                        <strong>Best Match:</strong>{{ sentence_data['best_match']|safe }} <br>
                                        <div class="source-detail">
                                            {{ sentence_data['word_count_sml'] }} word
                                            <i class="bi bi-x-circle icon-remove"></i>
                                        </div>
                                        
                                    </li>
                                {% endfor %}
                            </ul>
                            <!-- Phân trang -->
                            <div class="pagination">
                                <button id="prev-page-sentence-off-{{ school_id }}" onclick="prevSentencePage('{{ school_id }}', 'off')"><i class="bi bi-chevron-double-left"></i></button>
                                <span id="sentence-page-num-off-{{ school_id }}">1</span> / <span id="sentence-total-page-off-{{ school_id}}"></span>
                                <button id="next-page-sentence-off-{{ school_id }}" onclick="nextSentencePage('{{ school_id }}', 'off')"><i class="bi bi-chevron-double-right"></i></button>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- ON -->
                <div class="statistics-box overlapping-on" style="display: none;">
                    {% for school_id, school_data in school_source_on %}
                        <div class="school-box school-box-on highlight_school{{ school_id }}" onclick="toggleSchool_On('{{ school_id }}')">
                            <strong class="index-school-view index-school-view-on" style="background-color: {{ school_data['color'] }};">{{ loop.index }}</strong>
                            <div class="school_name">
                                <h5 style="color: {{school_data['color']}};">{{ school_data['school_name'] }}</h5>
                                <i class="bi bi-x-circle icon-remove" onclick="removeSchoolSource_On('{{school_id}}')"></i>
                            </div>
                            <br>
                            <strong>Word Matched:</strong> {{ school_data['word_count'] }}<br>
                            <strong>Percentage:</strong> {{ "%.2f" % ((school_data['word_count'] / word_count) * 100) }}%
                        </div>
                        <div class="sentence-box sentence-box-on" id="overlapping-on-{{ school_id }}" style="display: none;">
                            <ul class="sentence-list" id="sentence-list-on-{{ school_id }}">
                                {% for sentence_index, sentence_data in school_data['sentences'].items() %}
                                    <li class="sentence-item" data-page="{{ sentence_data['page'] }}">
                                        <a href="{{ sentence_data['file_id'] }}">{{ sentence_data['file_id'] }}</a><br>
                                        <strong>Best Match:</strong>{{ sentence_data['best_match']|safe }} <br>
                                        <div class="source-detail">
                                            {{ sentence_data['word_count_sml'] }} word
                                            <i class="bi bi-x-circle icon-remove"></i>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                            <div class="pagination">
                                <button id="prev-page-sentence-on-{{ school_id }}" onclick="prevSentencePage('{{ school_id }}', 'on')"><i class="bi bi-chevron-double-left"></i></button>
                                <span id="sentence-page-num-on-{{ school_id }}">1</span> / <span id="sentence-total-page-on-{{ school_id }}"></span>
                                <button id="next-page-sentence-on-{{ school_id }}" onclick="nextSentencePage('{{ school_id }}', 'on')"><i class="bi bi-chevron-double-right"></i></button>
                            </div>
                        </div>
                    {% endfor %}
                </div>

            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>

    <script>
        let pdfDoc = null;
        let currentPage = 1; // Biến lưu trang hiện tại

        async function loadPdf(pdfPath) {
            const loadingTask = pdfjsLib.getDocument(pdfPath);
            loadingTask.promise.then(pdf => {
                pdfDoc = pdf;
                renderAllPages(); // Tải tất cả các trang
            }).catch(error => {
                console.error('Error loading PDF:', error);
                alert('Could not load PDF. Please check the file ID and type.');
            });
        }

        function renderAllPages() {
            const pdfViewer = document.getElementById('pdf-viewer');
            pdfViewer.innerHTML = ''; // Xóa nội dung cũ trước khi thêm các trang mới

            for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                renderPage(pageNum); // Gọi hàm render cho từng trang
            }
        }

        function renderPage(pageNum) {
            pdfDoc.getPage(pageNum).then(page => {
                const scale = 1.5; // Thay đổi tỷ lệ nếu cần
                const viewport = page.getViewport({ scale: scale });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const pdfViewer = document.getElementById('pdf-viewer');
                pdfViewer.appendChild(canvas); // Thêm canvas vào pdfViewer

                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                page.render(renderContext);
            });
        }

        function scrollToPage(pageNum) {
            console.log(pageNum)

            const pdfViewer = document.getElementById('pdf-viewer');
            const canvases = pdfViewer.getElementsByTagName('canvas');

            // Cuộn đến vị trí của trang cụ thể
            if (canvases[pageNum]) {
                canvases[pageNum].scrollIntoView({ behavior: 'smooth' });
            }
        }

        window.onload = function() {
            const pdfPath = `/pdf/{{ file_id }}/checked`; // Đường dẫn đến PDF
            loadPdf(pdfPath); // Tải PDF khi trang được tải
        }

        const sentencesPerPage = 1;

        function showSentencePage(schoolId, type, pageNum) {
            const sentenceItems = document.querySelectorAll(`#sentence-list-${type}-${schoolId} .sentence-item`);
            const totalPages = Math.ceil(sentenceItems.length / sentencesPerPage);
            
            let firstDisplayedPage = null;  // Khởi tạo biến để lưu giá trị data-page của phần tử đầu tiên

            // Hiển thị các câu của trang hiện tại
            sentenceItems.forEach((item, index) => {
                if (index >= (pageNum - 1) * sentencesPerPage && index < pageNum * sentencesPerPage) {
                    item.style.display = "list-item";

                    // Chỉ lấy data-page của phần tử đầu tiên
                    if (firstDisplayedPage === null) {
                        firstDisplayedPage = item.getAttribute('data-page');
                    }
                } else {
                    item.style.display = "none";
                }
            });

            // Cập nhật số trang
            document.getElementById(`sentence-page-num-${type}-${schoolId}`).innerText = pageNum;
            document.getElementById(`sentence-total-page-${type}-${schoolId}`).innerText = totalPages;

            // Gọi hàm cuộn trang (giả định scrollToPage đã được định nghĩa)
            scrollToPage(firstDisplayedPage);
        }

        function nextSentencePage(schoolId, type) {
            const sentenceItems = document.querySelectorAll(`#sentence-list-${type}-${schoolId} .sentence-item`);
            const totalPages = Math.ceil(sentenceItems.length / sentencesPerPage);
            let currentPage = parseInt(document.getElementById(`sentence-page-num-${type}-${schoolId}`).innerText);

            if (currentPage < totalPages) {
                currentPage++;
                showSentencePage(schoolId, type, currentPage);
            }
        }

        function prevSentencePage(schoolId, type) {
            let currentPage = parseInt(document.getElementById(`sentence-page-num-${type}-${schoolId}`).innerText);

            if (currentPage > 1) {
                currentPage--;
                showSentencePage(schoolId, type, currentPage);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const sentenceBoxesOff = document.querySelectorAll(".sentence-box-off");
            const sentenceBoxesOn = document.querySelectorAll(".sentence-box-on");

            sentenceBoxesOff.forEach(box => {
                const schoolId = box.id.split("-")[2]; // Lấy school_id từ id
                showSentencePage(schoolId, 'off', 1);
            });

            sentenceBoxesOn.forEach(box => {
                const schoolId = box.id.split("-")[2]; // Lấy school_id từ id
                showSentencePage(schoolId, 'on', 1);
            });

        });
        
        function toggleOverlappingSources() {
            const overlappingStatistics_off = Array.from(document.getElementsByClassName("overlapping-off"));
            const overlappingStatistics_on = Array.from(document.getElementsByClassName("overlapping-on"));
            const toggleSwitch = document.getElementById("toggle-sources");      
            if (toggleSwitch.checked) {
                overlappingStatistics_off.forEach(el => {
                    el.style.display = "none";
                });
                overlappingStatistics_on.forEach(el => {
                    el.style.display = "block";
                });
                toggle_sources('raw')
            } else {
                overlappingStatistics_off.forEach(el => {
                    el.style.display = "block";
                });
                overlappingStatistics_on.forEach(el => {
                    el.style.display = "none";
                });
                toggle_sources('checked')
            }
        }

        function toggle_sources(type) {
            const pdfPath = `/pdf/{{ file_id }}/${type}`;
            loadPdf(pdfPath);
        }

        function toggleSchool_On(schoolId) {
            const elements = Array.from(document.getElementsByClassName("sentence-box-on"));
            const element = document.getElementById(`overlapping-on-${schoolId}`);
            const otherElements = elements.filter(el => el !== element);

            otherElements.forEach(el => {
                el.style.display = "none";
            });

            if (element.style.display === "none" || element.style.display === "") {
                element.style.display = "block";
                highlightSchool(schoolId);
                var firstSentenceItem = document.querySelector(`#overlapping-on-${schoolId} .sentence-item`);
                if (firstSentenceItem) {
                    var firstPageValue = firstSentenceItem.getAttribute('data-page');
                    scrollToPage(firstPageValue)
                }
            } else {
                element.style.display = "none";
                toggle_sources('raw');
            }
        }

        function highlightSchool(schoolId) {

            const pdfPath = `/pdf/{{ file_id }}/view_all/${schoolId}`;
            loadPdf(pdfPath);
        }
    
        function toggleSchool_Off(schoolId) {
            const elements = Array.from(document.getElementsByClassName("sentence-box-off"));
            const element = document.getElementById(`overlapping-off-${schoolId}`);
            const otherElements = elements.filter(el => el !== element);

            otherElements.forEach(el => {
                el.style.display = "none";
            });

            if (element.style.display === "none" || element.style.display === "") {
                element.style.display = "block";
                var firstSentenceItem = document.querySelector(`#overlapping-on-${schoolId} .sentence-item`);
                if (firstSentenceItem) {
                    var firstPageValue = firstSentenceItem.getAttribute('data-page');
                    scrollToPage(firstPageValue)
                }
            } else {
                element.style.display = "none";
            }
        }


        function removeSchoolSource_On(school_id) {
            const pdfPath = `/pdf/{{ file_id }}/remove/${school_id}`;

            fetch(pdfPath, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error deleting school source');
                }
                return response.json(); // Trả về school_source_on dưới dạng JSON
            })
            .then(data => {
                console.log('Response from server:', data); // Kiểm tra dữ liệu trả về

                // Xóa phần tử khỏi UI
                const schoolBoxes = document.querySelectorAll(`.highlight_school${school_id}`);
                schoolBoxes.forEach(schoolBox => {
                    schoolBox.remove(); // Xóa từng phần tử khỏi DOM
                });

                // Cập nhật lại số thứ tự
                updateSchoolSourceOnUI();
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        // Hàm cập nhật số thứ tự
        function updateSchoolSourceOnUI() {
            const schoolBoxes_On = document.querySelectorAll('.school-box-on'); // Lấy tất cả các phần tử school-box
            schoolBoxes_On.forEach((box, index) => {
                box.querySelector('.index-school-view-on').textContent = index + 1; // Cập nhật STT
            });

            const schoolBoxes_Off = document.querySelectorAll('.school-box-off'); // Lấy tất cả các phần tử school-box
            schoolBoxes_Off.forEach((box, index) => {
                box.querySelector('.index-school-view-off').textContent = index + 1; // Cập nhật STT
            });
        }

        function removeSchoolSource_Off(school_id) {
            const pdfPath = `/pdf/{{ file_id }}/remove/${school_id}`;

            fetch(pdfPath, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error deleting school source');
                }
                return response.json(); // Trả về school_source_on dưới dạng JSON
            })
            .then(data => {
                console.log('Response from server:', data); // Kiểm tra dữ liệu trả về

                // Xóa phần tử khỏi UI
                const schoolBoxes = document.querySelectorAll(`.highlight_school${school_id}`);
                schoolBoxes.forEach(schoolBox => {
                    schoolBox.remove(); // Xóa từng phần tử khỏi DOM
                });
                toggle_sources("checked")
                // Cập nhật lại số thứ tự
                updateSchoolSourceOnUI();
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

</body>
</html>
